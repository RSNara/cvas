<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Socket IO</title>
</head>
<body>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    (function(){
      const socket = io();
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      initCanvas();
      window.addEventListener('resize', initCanvas);
      document.body.style.margin = '0';
      document.body.style.overflow = 'hidden';
      document.body.appendChild(canvas);

      function initCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.style.backgroundColor = 'rgba(33,150,250,0.1)';
      }

      const state = {
        mousedown: null
      };

      const socketEmit = (message) => [message, (event) => {
        if (event.which === 1) {
          socket.emit(message, {
            clientX: event.clientX,
            clientY: event.clientY,
          });
        }
      }];

      canvas.addEventListener(...socketEmit('mouseup'));
      canvas.addEventListener(...socketEmit('mousedown'));
      canvas.addEventListener(...socketEmit('mousemove'));

      const handlers = {
        mouseup: () => {
          state.mousedown = false;
        },
        mousedown: (event) => {
          state.mousedown = true;
          ctx.beginPath();
          ctx.moveTo(event.clientX, event.clientY);
        },
        mousemove: (event) => {
          if (state.mousedown) {
            ctx.lineTo(event.clientX, event.clientY);
            ctx.stroke();
          }
        },
      };

      socket.on('init', (events) => {
        events.forEach((data) => {
          const eventName = data[0];
          const eventData = data[1];
          handlers[eventName](eventData);
        });
      });

      socket.on('mouseup', handlers.mouseup);
      socket.on('mousedown', handlers.mousedown);
      socket.on('mousemove', handlers.mousemove);
    })();
  </script>
</body>
</html>
